{% extends 'base.html' %}
{% load static %}
{% block content %}
<main class="main-content">
<div class="chat-container" id="chatAppContent" data-username="{{ request.user.username }}">
    <!-- LEFT CHAT LIST -->
    <div class="system-chats-list" id="chatList">
        <div class="list-header">
            <div class="list-header-top">
                <h3>Chats</h3>
                <div class="header-icons">
                    <span class="icon-with-tooltip">
                        <img src="{% static 'images/edit.png' %}" alt="chat icon" class="nav-icon-3" id="createNewChat">
                        <span class="tooltip-text">Create a new chat</span>
                    </span>
                    <div class="filter-dropdown-container">
                         <img src="{% static 'images/sliders.png' %}" alt="chat icon" class="nav-icon-2">
                        <div class="dropdown-content" id="filterDropdown">

                            <a href="{% url 'a_rtchat:filter_chats' 'all' %}" class="filter-option" data-filter="all">All Chats</a>
                            <a href="{% url 'a_rtchat:filter_chats' 'unread' %}" class="filter-option" data-filter="unread">Unread</a>
                            <a href="{% url 'a_rtchat:filter_chats' 'private' %}" class="filter-option" data-filter="private">Contacts</a>
                            <a href="{% url 'a_rtchat:filter_chats' 'group' %}" class="filter-option" data-filter="group">Groups</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" placeholder="Search chats..." class="list-search-input">
                <i class="fas fa-times-circle clear-search-icon" style="display: none;"></i>
            </div>
        </div>
        <!-- Looping over the single, combined list of all chats -->
        {% for chat in all_chats %}
            {% if chat.chat_type == 'group' %}
                <li class="contact-item group-chat" data-type="group" data-room="{{ chat.id }}">
                    <img src="{% static 'images/user.png' %}" alt="chat icon" class="nav-icon">
                    <div class="contact-info">
                        <span class="contact-name">{{ chat.name }}</span>
                        <span class="last-message">
                            {% if chat.last_message %}
                                {{ chat.last_message.message|truncatechars:30 }}
                            {% endif %}
                        </span>
                    </div>
                    <span class="message-time">
                        {% if chat.last_message %}
                            {{ chat.last_message.timestamp|date:"H:i" }}
                        {% endif %}
                    </span>
                    {% if chat.unread_count > 0 %}
                        <span class="unread-marker">{{ chat.unread_count }}</span>
                    {% endif %}
                </li>
            {% elif chat.chat_type == 'private' %}
                <li class="contact-item private-chat" data-type="private" data-room="{{ chat.id }}">
                    <img src="{% static 'images/user.png' %}" alt="chat icon" class="nav-icon">
                    <div class="contact-info">
                        <span class="contact-name">
                                {% if chat.other_user.first_name or chat.other_user.last_name %}
                                    {{ chat.other_user.first_name |title }} {{ chat.other_user.last_name | title }}
                                {% else %}
                                    {{ chat.other_user.username }}
                                {% endif %}
                        </span>
                        <span class="last-message">
                            {% if chat.last_message %}
                                {{ chat.last_message.message|truncatechars:30 }}
                            {% endif %}
                        </span>
                    </div>
                    <span class="message-time">
                        {% if chat.last_message %}
                            {{ chat.last_message.timestamp|date:"H:i" }}
                        {% endif %}
                    </span>
                    {% if chat.unread_count > 0 %}
                        <span class="unread-marker">{{ chat.unread_count }}</span>
                    {% endif %}
                </li>
            {% endif %}
        {% endfor %}
    </div>

    <!-- MAIN CHAT AREA -->
    <div class="chat-main" id="chatBody">
        <div class="chat-header">
            <div class="header-info">
                <button class="show-chat-list-btn" id="showChatListBtn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                 <img src="{% static 'images/user.png' %}" alt="chat icon" class="nav-icon">
                <span class="contact-name">
                    {% if chat_type == "group" %}
                        {{ active_group.name }}
                    {% elif chat_type == "private" %}
                        {{ other_username }}
                    {% else %}
                        Start a chat
                    {% endif %}
                </span>
            </div>
            <div class="header-actions">
                <!-- <i class="fas fa-search chat-search-icon" id="chatSearchToggle"></i> -->
            </div>
        </div>

        <div class="chat-search-overlay" id="chatSearchOverlay" style="display:none;">
            <input type="text" placeholder="Search within chat..." class="chat-search-input">
            <i class="fas fa-times-circle close-chat-search" id="closeChatSearch"></i>
        </div>

        <div class="chat-messages" id="chatMessages" data-room="{{ room_name }}">
            {% if messages %}
                {% for msg in messages %}
                    <div class="message {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
                        <strong>{{ msg.sender.username }}:</strong> {{ msg.message }}
                        <div class="timestamp">{{ msg.timestamp|date:"H:i" }}</div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align:center;color:#888;margin-top:20px;">
                    {% if room_name %}No messages in this chat yet{% else %}Select a chat to view messages{% endif %}
                </p>
            {% endif %}
        </div>

        <div class="chat-input-area">
            <input type="text" id="messageInput" class="message-input" placeholder="Type a message..." autocomplete="off">
            <button type="button" id="sendButton" class="send-button">
                <img src="{% static 'images/paper.png' %}" alt="chat icon" class="nav-icon">
            </button>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal-overlay" id="newChatModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Chat</h3>
            <i class="fas fa-times close-modal" id="closeNewChatModal"></i>
        </div>
        <div class="modal-body">
            <div class="chat-type-selector">
                <button class="chat-type-btn active" data-type="private">Private Chat</button>
                <button class="chat-type-btn" data-type="group">Group Chat</button>
            </div>
            
            <div id="privateChatForm" class="chat-form">
                <div class="form-group">
                    <label>Search User:</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="userSearchInput" placeholder="Search users...">
                    </div>
                    <div class="search-results" id="userSearchResults"></div>
                </div>
                <button id="createPrivateChatBtn" class="create-chat-btn">Start Chat</button>
            </div>
            
            <div id="groupChatForm" class="chat-form" style="display: none;">
                <div class="form-group">
                    <label>Group Name:</label>
                    <input type="text" id="groupNameInput" placeholder="Enter group name">
                </div>
                <div class="form-group">
                    <label>Add Members:</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="groupMemberSearch" placeholder="Search users to add...">
                    </div>
                    <div class="search-results" id="groupMemberResults"></div>
                </div>
                <div class="selected-members" id="selectedMembers"></div>
                <button id="createGroupChatBtn" class="create-chat-btn">Create Group</button>
            </div>
        </div>
    </div>
</div>
</main>
{% endblock %}
